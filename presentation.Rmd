---
output: ioslides_presentation
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE,
                      fig.width = 10,
                      fig.asp = 0.618,
                      fig.align = "center")


# read in the data, and organize it into a tidy format

library(tidyverse)
library(stringr)

demos <- read_csv("demos.csv")

test <- read_csv("test_scores.csv")

# actually some of the items in demos and others are related
# to discipline, so we should extract those
demos_tidy <- demos %>% 
  slice(1:7) %>% 
  gather(year, value, 2:5) %>% 
  rename(category = X1) %>% 
  mutate(value = str_extract(value, "[0-9]+"),
         pct = as.numeric(value) * .01) # extract the percentages

# add in a total students for each year
total <- demos_tidy %>% 
  filter(str_detect(category, "Total")) %>% 
  select(-category,
         -pct,
         total = value) %>% 
  mutate(total = as.numeric(total))

# and then multiply by percent to give the number in each category

demos_tidy <- demos_tidy %>% 
  filter(!str_detect(category, "Total")) %>% 
  left_join(total, by = "year") %>% 
  mutate(count = total * pct,
         category = str_replace(category, "% ", ""),
         category = recode(category, 
                           "Students as English Language Learners" = "ELLs",
                           "Students with Disabilities" = "IEP")) %>% 
  select(-value)

# now moving on to outcomes/test scores
out <- test %>% 
  gather(year, pct, 3:6) %>% 
  mutate(subj = str_extract(`Academic Years`, "reading|math"),
         pct = as.numeric(str_replace(pct, "%", "")) * .01) %>% 
  select(-`Academic Years`,
         grade = X2) %>% 
  unite(obs, grade, subj, sep = " ") %>% 
  mutate(obs = paste0(obs, " prof"))

# we will add % with >95% attendance and pct with 0 suspensions (climate) 
# into the outcomes table, because it might be helpful to look at them together
climate <- demos %>% 
  slice(10:11) %>% 
  gather(year, pct, 2:5) %>% 
  mutate(obs = if_else(str_detect(X1, "Suspensions"), 
                       "0 suspensions", 
                       "95% attendance"),
         pct = as.numeric(str_replace(pct, "%", "")) * .01) %>% 
  select(-X1)

out <- bind_rows(out, climate)

# climate will remain separate because the unit of obervation is
# a referral, not a student
discipline <- demos %>% 
  slice(8:9) %>% 
  gather(year, value, 2:5) %>% 
  spread(X1, value) %>% 
  select(1,referrals = 2, pct_susp = 3) %>% 
  mutate(pct_susp = as.numeric(str_replace(pct_susp, "%", "")) * .01,
         suspension = as.numeric(referrals) * pct_susp) %>% 
  select(-pct_susp) %>% 
  gather(type, count, 2:3) %>% 
  mutate(count = as.numeric(count))

```


## Changes in demographics
```{r}

demos_tidy %>% 
  ggplot(aes(x = year, y = pct, group = category, color = category)) +
    geom_line(size = 2)

```


```{r}

demos_tidy %>% 
  filter(year %in% c("2013-2014", "2016-2017")) %>% 
  select(-pct, -total) %>% 
  spread(year, count) %>% 
  mutate(pct_change = (`2016-2017` - `2013-2014`) / `2013-2014`) %>% 
  ggplot(aes(category, pct_change)) +
    geom_bar(stat = "identity") + 
    scale_y_continuous(limits = c(-3, 3)) 

```

## Changes in climate

```{r}
discipline %>% 
  ggplot(aes(year, count, group = type, color = type)) + 
    geom_line(size = 2)

```


## Changes in outcomes
```{r}

out %>% 
  ggplot(aes(year, pct, group = obs, color = obs)) + 
    geom_line(size = 2)


```

```{r}

change_pct <- function(start, x) {
  x <- (x - start) / start
  x
}
  

out_wide <- out %>% 
  spread(year, pct)

out_wide[, 3:5] <- sapply(out_wide[, 3:5], function(x) {
  x <- change_pct(out_wide$`2013-2014`, x)
  x
})

out_wide$`2013-2014` <- 0

out_wide %>% 
  gather(year, pct_change, 2:5) %>% 
  ggplot(aes(year, pct_change, color = obs, group = obs)) +
    geom_line(size = 2, alpha = 0.75)

  
```


```{r}
out %>% 
  filter(year %in% c("2013-2014", "2016-2017")) %>% 
  spread(year, pct) %>% 
  mutate(pct_change = (`2016-2017` - `2013-2014`) / `2013-2014`) %>% 
  ggplot(aes(str_wrap(obs, 10), pct_change)) +
    geom_bar(stat = "identity")
```

